---
title: "covid-19 data collection"
output: html_document
date: "2023-07-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggthemes)
library(scales)
library(lubridate)
library(flextable)
library(httr)
library(jsonlite)
library(zoo)
```

# COVID-19 daily case data from WHO

```{r data, paged.print=TRUE}
link <- "https://covid19.who.int/WHO-COVID-19-global-data.csv"
download.file(link, "WHO-COVID-19-global-data.csv")
data <- read_csv("WHO-COVID-19-global-data.csv") |> 
  filter(Country_code %in% c("BN", "KH", "ID", "LA", "PH", "TH", "VN", "MM", "SG", "MY")) |> 
  mutate(Country = replace(Country, Country == "Lao People's Democratic Republic", "Lao PDR"),
         Country = replace(Country, Country == "Brunei Darussalam", "Brunei DS"),
         Country = replace(Country, Country == "Viet Nam", "Vietnam"))
#tail(data)
#View(data)
```

```{r}
data |> group_by(Country) |> filter(Date_reported <= "2022-12-31") |> 
  summarise(cum_death_2023 = sum(New_deaths))
```


# COVID-19 data from OWID
```{r data, paged.print=TRUE}
link <- "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv"
download.file(link, "owid-covid-data.csv")
data <- read_csv("owid-covid-data.csv") |> 
  filter(iso_code %in% c("BRN", "KHM", "IDN", "LAO", "PHL", "THA", "VNM", "MMR", "SGP", "MYS")) |> 
  mutate(location = replace(location, location == "Laos", "Lao PDR"),
         location = replace(location, location == "Brunei", "Brunei DS")) |> 
  select(iso_code, location, date, new_cases, new_deaths)
```

# Weekly graph

```{r weekly data}
weeklyData <- data |> filter(Date_reported >= "2022-12-25") |> 
  mutate(week = epiweek(Date_reported)) |> group_by(Country, week) |> 
  summarise(weekly_cases = sum(New_cases)) |> 
  mutate(date = ymd("2022-12-25") + weeks(week)) |> 
  filter(week != 52, weekly_cases >= 1)
weeklyDeath <- data |> filter(Date_reported >= "2022-12-25") |> 
  mutate(week = epiweek(Date_reported)) |> group_by(week) |> 
  summarise(weekly_deaths = sum(New_deaths)) |> 
  mutate(date = ymd("2022-12-25") + weeks(week)) |> 
  filter(week != 52, week != 47)
#weeklyDeath[5,2] <- 84
```

```{r weekly plot}
plot <- ggplot() +
  geom_area(data = weeklyData, aes(x = date, y = weekly_cases, fill = Country)) + 
  geom_line(data = weeklyDeath, aes(date, weekly_deaths*200, colour = "Number of Death"), linetype = "solid", linewidth = 1.2) +
  scale_y_continuous(sec.axis = sec_axis(~ . / 200, name = "No. of Death"), name = "Weekly Cases") +
  scale_x_date(breaks = "1 month", labels = date_format("%b-%Y"),
               limits = as.Date(c('2022-12-25','2023-11-01')), name = element_blank()) +
  scale_colour_manual("", breaks = c("Number of Death"), values = "black") +
  theme(legend.title = element_blank()) +
  theme_hc()
plot
```

```{r export}
png("weekly curve COVID-19 ASEAN 28 November 2023 area.png", units="px", width=3000, height=2250, res=300)
plot
dev.off()
```

# 7MA Graph
```{r}
maData <- data |> filter(date >= "2023-01-01") |> 
  group_by(location) |> 
  mutate(ma_new_cases = round(rollmean(new_cases, k = 7, fill = 0), 2)) |> 
  ungroup()
maDeath <- data |> filter(date >= "2023-01-01") |> group_by(date) |> 
  summarise(new_deaths = sum(new_deaths)) |> 
  mutate(ma_new_deaths = round(rollmean(new_deaths, k = 7, fill = 0), 2))
```

```{r}
ggplot(data = maData, aes(date, ma_new_cases)) + geom_area(aes(fill = location)) + 
  geom_line()
```


# COVID-19 vaccine data

```{r data}
#link <- "https://covid19.who.int/who-data/vaccination-data.csv"
#download.file(link, "vaccination-data.csv")
vacc <- read_csv("vaccination-data.csv") |> 
  filter(ISO3 %in% c("BRN", "KHM", "IDN", "LAO", "PHL", "THA", "VNM", "MMR", "SGP", "MYS")) |>  # nolint # nolint: line_length_linter.
  mutate(COUNTRY = replace(COUNTRY, COUNTRY == "Lao People's Democratic Republic", "Lao PDR"),
         COUNTRY = replace(COUNTRY, COUNTRY == "Viet Nam", "Vietnam")) |> 
  select(1, 5, 7, 9, 10, 11, 15, 16) |> arrange(COUNTRY)
flextable(vacc)
```

```{r}
url <- "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations.csv"
download.file(url, "vaccinations.csv")
data <- read_csv("vaccinations.csv") |> filter(iso_code %in% c("BRN", "KHM", "IDN", "LAO", "PHL", "THA", "VNM", "MMR", "SGP", "MYS"))
```

```{r}
data |> group_by(location) |> filter(row_number()==1)
```


```{r}
ggplot(data, aes(date, daily_vaccinations)) + geom_line(aes(color = iso_code))
```




# Indicator-based Surveillance from Bluedot 

```{r}
startDate <- "2023-10-01"
endDate <- "2023-10-21"
covUrl <- paste0("https://developer.bluedot.global/casecounts/indicator-based/?diseaseIds=200&locationIds=1880251,%201605651,%201694008,%201820814,%201733045,%201643084,%201831722,%201327865,%201655842,1562822&startDate=", startDate, "&endDate=", endDate, "&api-version=v1")
res <- GET(covUrl, add_headers("Ocp-Apim-Subscription-Key" = "371e207132a2497f8e981a8d3264788b", "Cache-Control" = "no-cache")) |> content()
covData <- enframe(pluck(res, "data")) |> unnest_wider(value)
View(covData)
flextable(covData)
```

# COVID-19 from OWID

```{r}
link <- "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/latest/owid-covid-latest.csv"
download.file(link, "owid-covid-latest.csv")
owid_data <- read_csv("owid-covid-latest.csv") |> filter(iso_code %in% c("BRN", "KHM", "IDN", "LAO", "PHL", "THA", "VNM", "MMR", "SGP", "MYS"))
View(data)
```

# COVID-19 News
```{r}
url <- "https://developer.bluedot.global/casecounts/diseases/200?locationIds=1880251,%201605651,%201694008,%201820814,%201733045,%201643084,%201831722,%201327865,%201655842,1562822&startDate=2023-10-13&endDate=2023-10-19&isAggregated=false&includeSources=true&api-version=v1"
res <- GET(url, add_headers("Ocp-Apim-Subscription-Key" = "5f645982e25d4a729d7292b890a8ed31", "Cache-Control" = "no-cache")) |> content()
length_df <- length(res$data)
covNews <- data.frame()
for(i in 1:length_df){
  disease_name <- pluck(res, "data", i, "diseaseName")
  vec <- enframe(pluck(res, "data", i, "sources")) |> unnest_wider(value)
  vec$name <- disease_name
  covNews <- rbind(covNews, vec)
}
flextable(covNews)
```

