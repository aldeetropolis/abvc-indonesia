---
title: "covid-19 data collection"
output: html_document
date: "2023-07-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggthemes)
library(scales)
library(lubridate)
library(flextable)
library(httr)
library(jsonlite)
```

# COVID-19 daily case data from WHO

```{r data, paged.print=TRUE}
link <- "https://covid19.who.int/WHO-COVID-19-global-data.csv"
download.file(link, "WHO-COVID-19-global-data.csv")
data <- read_csv("WHO-COVID-19-global-data.csv") |> 
  filter(Country_code %in% c("BN", "KH", "ID", "LA", "PH", "TH", "VN", "MM", "SG", "MY")) |> 
  mutate(Country = replace(Country, Country == "Lao People's Democratic Republic", "Lao PDR"),
         Country = replace(Country, Country == "Viet Nam", "Vietnam"),
         Country = replace(Country, Country == "Brunei Darussalam", "Brunei DS"))
#tail(data)
#View(data)
```

```{r}
data |> filter(Country_code == "SG", Date_reported < '2023-01-01') |> count(sum = sum(New_cases))
```

```{r plot}
plot <- ggplot(reportData) + 
  geom_line(aes(Date_reported, case, color = Country), linewidth = 1.2) +
  scale_y_continuous(labels = label_number(suffix = "K", scale = 1e-3)) +
  theme(legend.title = element_blank()) +
  ylab("Cumulative cases") +
  scale_x_date(labels = date_format("%b-%Y"), name = element_blank()) +
  theme_hc()
plot
```

```{r export}
jpeg("epicurve COVID-19 ASEAN 20 July 2023.jpeg", units="px", width=4000, height=2250, res=300)
plot
dev.off()
```

# Weekly graph

```{r weekly data}
weeklyData <- data |> filter(Date_reported >= "2022-12-25") |> 
  mutate(week = epiweek(Date_reported)) |> group_by(Country, week) |> 
  summarise(weekly_cases = sum(New_cases),
            weekly_death = sum(New_deaths)) |> 
  mutate(date = ymd("2022-12-25") + weeks(week)) |> 
  filter(week != 52, weekly_cases >= 1)
weeklyDeath <- weeklyData |> group_by(week) |> 
  summarise(death = sum(weekly_death)) |> 
  mutate(date = ymd("2022-12-25") + weeks(week)) |> filter(week != 52)
```

```{r weekly plot}
plot <- ggplot() +
  geom_area(data = weeklyData, aes(x = date, y = weekly_cases, fill = Country)) + 
  geom_line(data = weeklyDeath, aes(date, death*200, colour = "Number of Death"), linetype = "solid", linewidth = 1.2) +
  scale_y_continuous(sec.axis = sec_axis(~ . / 200, name = "No. of Death"), name = "Weekly Cases") +
  scale_x_date(breaks = "1 month", labels = date_format("%b-%Y"),
               limits = as.Date(c('2023-01-01','2023-10-12')), name = element_blank()) +
  scale_colour_manual("", breaks = c("Number of Death"), values = "black") +
  theme(legend.title = element_blank()) +
  theme_hc()
plot
```

```{r export}
png("weekly curve COVID-19 ASEAN 24 October 2023 area.png", units="px", width=3000, height=2250, res=300)
plot
dev.off()
```

# COVID-19 vaccine data

```{r data}
link <- "https://covid19.who.int/who-data/vaccination-data.csv"
download.file(link, "vaccination-data.csv")
vacc <- read_csv("vaccination-data.csv") |> 
  filter(ISO3 %in% c("BRN", "KHM", "IDN", "LAO", "PHL", "THA", "VNM", "MMR", "SGP", "MYS")) |>  # nolint # nolint: line_length_linter.
  mutate(COUNTRY = replace(COUNTRY, COUNTRY == "Lao People's Democratic Republic", "Lao PDR"),
         COUNTRY = replace(COUNTRY, COUNTRY == "Viet Nam", "Vietnam")) |> 
  select(1, 5, 7, 9, 10, 11, 15, 16)
flextable(vacc)
```

# Indicator-based Surveillance from Bluedot 

```{r}
startDate <- "2023-10-01"
endDate <- "2023-10-21"
covUrl <- paste0("https://developer.bluedot.global/casecounts/indicator-based/?diseaseIds=200&locationIds=1880251,%201605651,%201694008,%201820814,%201733045,%201643084,%201831722,%201327865,%201655842,1562822&startDate=", startDate, "&endDate=", endDate, "&api-version=v1")
res <- GET(covUrl, add_headers("Ocp-Apim-Subscription-Key" = "371e207132a2497f8e981a8d3264788b", "Cache-Control" = "no-cache")) |> content()
covData <- enframe(pluck(res, "data")) |> unnest_wider(value)
View(covData)
flextable(covData)
```

# COVID-19 from OWID

```{r}
link <- "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/latest/owid-covid-latest.csv"
download.file(link, "owid-covid-latest.csv")
owid_data <- read_csv("owid-covid-latest.csv") |> filter(iso_code %in% c("BRN", "KHM", "IDN", "LAO", "PHL", "THA", "VNM", "MMR", "SGP", "MYS"))
View(data)
```

# COVID-19 News
```{r}
url <- "https://developer.bluedot.global/casecounts/diseases/200?locationIds=1880251,%201605651,%201694008,%201820814,%201733045,%201643084,%201831722,%201327865,%201655842,1562822&startDate=2023-10-13&endDate=2023-10-19&isAggregated=false&includeSources=true&api-version=v1"
res <- GET(url, add_headers("Ocp-Apim-Subscription-Key" = "5f645982e25d4a729d7292b890a8ed31", "Cache-Control" = "no-cache")) |> content()
length_df <- length(res$data)
covNews <- data.frame()
for(i in 1:length_df){
  disease_name <- pluck(res, "data", i, "diseaseName")
  vec <- enframe(pluck(res, "data", i, "sources")) |> unnest_wider(value)
  vec$name <- disease_name
  covNews <- rbind(covNews, vec)
}
flextable(covNews)
```

