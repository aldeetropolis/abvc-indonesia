---
title: "Mpox data collection"
output: html_document
date: "2023-07-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(flextable)
library(zoo)
library(jsonlite)
library(httr)
```

# Data import

```{r data}
link <- "https://raw.githubusercontent.com/owid/monkeypox/main/owid-monkeypox-data.csv"
download.file(link, "mpox-owid.csv")
data <- read_csv("mpox-owid.csv")
world_data <- data |> filter(iso_code == "OWID_WRL", date >= "2023-01-01") |> mutate(new_cases_ma = rollmean(new_cases, k = 7, fill = NA))
```

## Mpox World Plot

```{r world, echo=FALSE}
mpox_world_plot <- ggplot(data = world_data, aes(x = date, y = new_cases_ma)) + 
  geom_line(color = "blue") + 
  labs(x = element_blank(), y = "Number of Cases") +
  scale_y_continuous("Number of Cases",
                     breaks = c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                     minor_breaks = NULL) +
  scale_x_date(minor_breaks = NULL, date_breaks = "month", date_labels = "%b") +
  theme_linedraw()
mpox_world_plot
```

```{r}
png("mpox world 5 october 2023.jpeg", units="px", width=4000, height=2250, res=300)
mpox_world_plot
dev.off()
```


# Mpox cases in the ASEAN Region (Jan. 1 to 5 Oct, 2023)
```{r}
asean_data <- data |> filter(iso_code %in% c("BRN", "KHM", "IDN", "LAO", "PHL", "THA", "VNM", "MMR", "SGP", "MYS"), date >= "2023-01-01")
asean_data |> 
  group_by(location) |> 
  summarise(cum_cases = sum(new_cases), cum_death = sum(new_deaths), cfr = round((cum_death/cum_cases)*100, 2))
```

```{r}
asean_data |> summarise(cum_cases = sum(new_cases), cum_death = sum(new_deaths), cfr = round((cum_death/cum_cases)*100, 2))
```


```{r}
asean_data |> group_by(location) |> 
  slice(tail(row_number(), 7)) |> 
  select(1:7)
```

# Mpox cases in the Asia-Pacific region (Jan. 1 to Oct 4, 2023)
```{r}
ap_data <- data |> filter(iso_code %in% c("AUS", "IND", "JPN", "NPL", "NZL", "CHN", "KOR", "LKA"), date >= "2023-01-01")
ap_data |> group_by(location) |> 
  summarise(cum_cases = sum(new_cases), cum_death = sum(new_deaths), cfr = round((cum_death/cum_cases)*100, 2))
```

```{r}
ap_data |> summarise(cum_cases = sum(new_cases), cum_death = sum(new_deaths), cfr = round((cum_death/cum_cases)*100, 2))
```

```{r}
ap_data |> group_by(location) |> 
  slice(tail(row_number(), 7)) |> 
  select(1:7)
```

# Top 5 countries with the most mpox cases globally (Jan. 1 to Oct. 2, 2023)
```{r}
data |> filter(date >= "2023-01-01", !grepl("OWID", iso_code)) |> 
  group_by(location) |> summarise(cum_cases = sum(new_cases), cum_death = sum(new_deaths)) |> 
  arrange(-cum_cases) |> top_n(5, cum_cases)
```

# Mpox cases per region
```{r}
region_data <- read_csv("mpox cases by country as of 30 September 2023.csv") |> filter(date >= "2023-01-01") |> 
  mutate(region = if_else(iso3 %in% c("BRN", "KHM", "IDN", "LAO", "PHL", "THA", "VNM", "MMR", "SGP", "MYS"), "ASEAN",
                          if_else(who_region %in% c("South-East Asia Region", "Western Pacific Region"), "Asia Pacific", who_region))) |> 
  group_by(region) |> 
  summarise(cum_cases = sum(new_confirmed_cases), cum_death = sum(new_deaths))
region_data
```

# Indicator-based Surveillance from Bluedot
```{r}
covUrl <- paste0("https://developer.bluedot.global/casecounts/indicator-based/?diseaseIds=64&locationIds=1880251,%201605651,%201694008,%201820814,%201733045,%201643084,%201831722,%201327865,%201655842,1562822&startDate=2023-01-01&api-version=v1")
res <- GET(covUrl, add_headers("Ocp-Apim-Subscription-Key" = "371e207132a2497f8e981a8d3264788b", "Cache-Control" = "no-cache")) |> content()
covData <- enframe(pluck(res, "data")) |> unnest_wider(value) |> filter(countryISO == "SGP", sourceOrgName == "OWID")
covData |> summarise(n = sum(totalReportedCases))
```

